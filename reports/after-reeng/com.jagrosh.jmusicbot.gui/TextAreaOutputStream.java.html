<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextAreaOutputStream.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JMusicBot</a> &gt; <a href="index.source.html" class="el_package">com.jagrosh.jmusicbot.gui</a> &gt; <span class="el_source">TextAreaOutputStream.java</span></div><h1>TextAreaOutputStream.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017 John Grosh &lt;john.a.grosh@gmail.com&gt;.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.jagrosh.jmusicbot.gui;

import java.awt.*;
import java.io.*;
import java.util.*;
import java.util.List;
import javax.swing.*;

/**
 * @author Lawrence Dol
 */
public class TextAreaOutputStream extends OutputStream {

// *************************************************************************************************
// INSTANCE MEMBERS
// *************************************************************************************************

    private byte[] oneByte;                                                    // array for write(int val);
    private Appender appender;                                                   // most recent action

    public TextAreaOutputStream(JTextArea txtara) {
<span class="nc" id="L37">        this(txtara, 1000);</span>
<span class="nc" id="L38">    }</span>

<span class="nc" id="L40">    public TextAreaOutputStream(JTextArea txtara, int maxlin) {</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (maxlin &lt; 1) {</span>
<span class="nc" id="L42">            throw new IllegalArgumentException(&quot;TextAreaOutputStream maximum lines must be positive (value=&quot; + maxlin + &quot;)&quot;);</span>
        }
<span class="nc" id="L44">        oneByte = new byte[1];</span>
<span class="nc" id="L45">        appender = new Appender(txtara, maxlin);</span>
<span class="nc" id="L46">    }</span>

    /**
     * Clear the current console text area.
     */
    public synchronized void clear() {
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (appender != null) {</span>
<span class="nc" id="L53">            appender.clear();</span>
        }
<span class="nc" id="L55">    }</span>

    @Override
    public synchronized void close() {
<span class="nc" id="L59">        appender = null;</span>
<span class="nc" id="L60">    }</span>

    @Override
    public synchronized void flush() {
        /* empty */
<span class="nc" id="L65">    }</span>

    @Override
    public synchronized void write(int val) {
<span class="nc" id="L69">        oneByte[0] = (byte) val;</span>
<span class="nc" id="L70">        write(oneByte, 0, 1);</span>
<span class="nc" id="L71">    }</span>

    @Override
    public synchronized void write(byte[] ba) {
<span class="nc" id="L75">        write(ba, 0, ba.length);</span>
<span class="nc" id="L76">    }</span>

    @Override
    public synchronized void write(byte[] ba, int str, int len) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (appender != null) {</span>
<span class="nc" id="L81">            appender.append(bytesToString(ba, str, len));</span>
        }
<span class="nc" id="L83">    }</span>

    //@edu.umd.cs.findbugs.annotations.SuppressWarnings(&quot;DM_DEFAULT_ENCODING&quot;)
    static private String bytesToString(byte[] ba, int str, int len) {
        try {
<span class="nc" id="L88">            return new String(ba, str, len, &quot;UTF-8&quot;);</span>
<span class="nc" id="L89">        } catch (UnsupportedEncodingException thr) {</span>
<span class="nc" id="L90">            return new String(ba, str, len);</span>
        } // all JVMs are required to support UTF-8
    }

// *************************************************************************************************
// STATIC MEMBERS
// *************************************************************************************************

    //TODO extract
    static class Appender
            implements Runnable {
        static private final String EOL1 = &quot;\n&quot;;
<span class="nc" id="L102">        static private final String EOL2 = System.getProperty(&quot;line.separator&quot;, EOL1);</span>

        private final JTextArea textArea;
        private final int maxLines;                                                   // maximum lines allowed in text area
        private final LinkedList&lt;Integer&gt; lengths;                                                    // length of lines within text area
        private final List&lt;String&gt; values;                                                     // values waiting to be appended

        private int curLength;                                                  // length of current line
        private boolean clear;
        private boolean queue;

<span class="nc" id="L113">        Appender(JTextArea txtara, int maxlin) {</span>
<span class="nc" id="L114">            textArea = txtara;</span>
<span class="nc" id="L115">            maxLines = maxlin;</span>
<span class="nc" id="L116">            lengths = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L117">            values = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L119">            curLength = 0;</span>
<span class="nc" id="L120">            clear = false;</span>
<span class="nc" id="L121">            queue = true;</span>
<span class="nc" id="L122">        }</span>

        private synchronized void append(String val) {
<span class="nc" id="L125">            values.add(val);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (queue) {</span>
<span class="nc" id="L127">                queue = false;</span>
<span class="nc" id="L128">                EventQueue.invokeLater(this);</span>
            }
<span class="nc" id="L130">        }</span>

        private synchronized void clear() {
<span class="nc" id="L133">            clear = true;</span>
<span class="nc" id="L134">            curLength = 0;</span>
<span class="nc" id="L135">            lengths.clear();</span>
<span class="nc" id="L136">            values.clear();</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if (queue) {</span>
<span class="nc" id="L138">                queue = false;</span>
<span class="nc" id="L139">                EventQueue.invokeLater(this);</span>
            }
<span class="nc" id="L141">        }</span>

        // TODO check
        // MUST BE THE ONLY METHOD THAT TOUCHES textArea!
        @Override
        public synchronized void run() {
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (clear) {</span>
<span class="nc" id="L148">                textArea.setText(&quot;&quot;);</span>
            }
<span class="nc" id="L150">            values.stream().map((val) -&gt; {</span>
<span class="nc" id="L151">                curLength += val.length();</span>
<span class="nc" id="L152">                return val;</span>
<span class="nc" id="L153">            }).map((val) -&gt; {</span>
<span class="nc bnc" id="L154" title="All 4 branches missed.">                if (val.endsWith(EOL1) || val.endsWith(EOL2)) {</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if (lengths.size() &gt;= maxLines) {</span>
<span class="nc" id="L156">                        textArea.replaceRange(&quot;&quot;, 0, lengths.removeFirst());</span>
                    }
<span class="nc" id="L158">                    lengths.addLast(curLength);</span>
<span class="nc" id="L159">                    curLength = 0;</span>
                }
<span class="nc" id="L161">                return val;</span>
<span class="nc" id="L162">            }).forEach((val) -&gt; {</span>
<span class="nc" id="L163">                textArea.append(val);</span>
<span class="nc" id="L164">            });</span>
<span class="nc" id="L165">            values.clear();</span>
<span class="nc" id="L166">            clear = false;</span>
<span class="nc" id="L167">            queue = true;</span>
<span class="nc" id="L168">        }</span>
    }
} /* END PUBLIC CLASS */
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>